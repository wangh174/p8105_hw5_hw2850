---
title: "p8105_hw5_hw2850"
author: "Haoyang Wang"
date: "2022-11-06"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r} 
library(tidyverse)
library(rvest)
```

#Problem 2
```{r}
homicide_raw = read_csv("data/homicide-data.csv") %>% 
  janitor::clean_names()
```
The raw data contains the homicides victims' information including the reported
date, victims' names, victims' age, victims' race, victims' sex, the cities and
the states that homicides occurred, the precise location of homicides (latitude,
longitude), and the disposition/result of homicides. 

```{r}
homicide_city_state = read_csv("data/homicide-data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(.data = ., city_state = str_c(city, ", " ,state)) %>% 
  select(-city, -state) %>% 
  mutate(
    disposition = if_else(disposition %in% c("Closed without arrest", "Open/No arrest"), "unsolved_homicides", "homicides") 
  )
```
Combine variables "cities" and "states" into one variable "city_state". Group "Closed without arrest" and "Open/No arrest" into category "unsolved homicides". Group "Closed by arrest" into category "homicides".

```{r}
homicide_by_cities = homicide_city_state %>% 
  group_by(city_state, disposition) %>% 
  summarize(n_obs = n())
```
Summarize within cities to obtain the total number of homicides and the number of unsolved homicides.

```{r}
homicide_pivot = pivot_wider(
  homicide_by_cities,
  names_from = "disposition",
  values_from = "n_obs") 

homicide_pivot[is.na(homicide_pivot)] <- 0 #Change Tulsa, AL NA value to 0
```
Pivot_wider the homicide_by_cities dataset.

```{r}
homicide_pivot = 
  mutate(homicide_pivot,
  total = homicides + unsolved_homicides) #get a total homicides column by adding homicides and unsolved homicides
```
Add a total column for the total number of homicides.

```{r}
Baltimore = homicide_pivot %>% 
  filter(city_state == "Baltimore, MD") #get a Baltimore dataset
```
Filter dataset with only city Baltimore, MD.

```{r}
Baltimore_proptest = prop.test(
  x = pull(Baltimore, unsolved_homicides),
  n = pull(Baltimore, total)) %>% 
  broom::tidy() %>% 
  select(estimate, conf.low, conf.high)
```
Do prop.test with city Baltimore data. The estimate proportion of unsolved homicides is `r pull(Baltimore_proptest, estimate)`. The confidence interval is between `r pull(Baltimore_proptest, conf.low)` and `r pull(Baltimore_proptest, conf.high)`.

```{r}
prop_test = function(homicide_pivot){
  
  proptest = prop.test(
    x = pull(homicide_pivot, unsolved_homicides),
    n = pull(homicide_pivot, total)) %>% 
    broom::tidy() %>% 
    select(estimate, conf.low, conf.high)
  
  proptest #output
}
```
Write a function about prop.test.

```{r}
city_homicides = homicide_pivot %>% 
  nest(data = unsolved_homicides:total) %>% #nest variables unsolved_homicides and total within tidied homicide_pivot dataset 
  mutate(results = map(data, prop_test)) %>% 
  select(city_state, results) %>% 
  unnest(cols = results) #unnest the results
```
Create a dataframe with estimated proportions and CIs for each city by applying function.

```{r}
city_plot = city_homicides %>% 
  mutate(city_state, fct_reorder(city_state, estimate)) %>% #order the cities by their estimate proportion
  ggplot(aes(x = estimate, y = city_state))+
  geom_point()+
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high)) #add confidence interval

city_plot 

ggsave("50 Large U.S. Cities Unsolved Homicides Proportion Estimate.pdf", plot = city_plot)
```
Create a plot showing the estimates and confidence intervals for each city. From the plot we can see that Chicago, IL has the highest unsolved homicides proportion estimate. Tulsa, AL has the lowest unsolved homicides proportion estimate. However, there were not enough data for Tulsa, AL. The result may not be conclusive.   



